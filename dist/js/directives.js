!function($app){var patternFormat=function(e){return e?$(e).attr("format")||"DD/MM/YYYY":"DD/MM/YYYY"},parsePermission=function(e){var t={visible:{public:!0},enabled:{public:!0}};if(e)for(var a=e.toLowerCase().trim().split(","),i=0;i<a.length;i++){var r=a[i].trim();if(r){var n=r.split(":");if(2==n.length){var l=n[0].trim(),o=n[1].trim();if(o){for(var s=o.split(";"),d={},c=0;c<s.length;c++){var u=s[c].trim();u&&(d[u]=!0)}t[l]=d}}}}return t};app.directive("asDate",function(){return{require:"^ngModel",restrict:"A",link:function(e,t,a,i){function r(){var e=t.val(),a=moment(e,patternFormat(t));a.isValid()&&i.$setViewValue(a.toDate())}if(i){var n=patternFormat(t),l={format:n,locale:"pt-BR",showTodayButton:!0,useStrict:!0,tooltips:{today:"Hoje",clear:"Limpar seleção",close:"Fechar",selectMonth:"Selecionar mês",prevMonth:"Mês anterior",nextMonth:"Próximo mês",selectYear:"Selecionar ano",prevYear:"Ano anterior",nextYear:"Próximo ano",selectDecade:"Selecionar década",prevDecade:"Década anterior",nextDecade:"Próxima década",prevCentury:"Século anterior",nextCentury:"Próximo século"}};"DD/MM/YYYY"!=n&&(l.sideBySide=!0),t.datetimepicker(l),t.on("dp.change",function(){$(this).is(":visible")&&e.$apply(r)}),i.$render=function(){if(i.$viewValue){var e=parseInt(i.$viewValue,10),a=moment(e);a.isValid()?t.val(a.format(patternFormat(t))):t.val("")}else t.data("DateTimePicker").clear(),t.val("")},r()}}}}).directive("ngDestroy",function(){return{restrict:"A",link:function(scope,element,attrs,ctrl){element.on("$destroy",function(){attrs.ngDestroy&&attrs.ngDestroy.length>0&&(attrs.ngDestroy.indexOf("app.")>-1||attrs.ngDestroy.indexOf("blockly.")>-1?scope.$eval(attrs.ngDestroy):eval(attrs.ngDestroy))})}}}).directive("dynamicImage",["$compile",function(e){return{restrict:"A",scope:!0,require:"ngModel",link:function(t,a,i){var r=i.ngRequired&&"true"==i.ngRequired?"required":"",n=a.html(),l='<div ngf-drop="" ngf-drag-over-class="dragover">                   <img style="width: 100%;" ng-if="$ngModel$" data-ng-src="{{$ngModel$.startsWith(\'http\') || ($ngModel$.startsWith(\'/\') && $ngModel$.length < 1000)? $ngModel$ : \'data:image/png;base64,\' + $ngModel$}}">                   <div class="btn" ng-if="!$ngModel$" ngf-drop="" ngf-select="" ngf-change="cronapi.internal.setFile(\'$ngModel$\', $file)" ngf-pattern="\'image/*\'" ngf-max-size="$maxFileSize$">                     $userHtml$                   </div>                   <div class="remove-image-button button button-assertive" ng-if="$ngModel$" ng-click="$ngModel$=null">                     <span class="icon ion-android-close"></span>                   </div>                   <div class="button button-positive" ng-if="!$ngModel$" ng-click="cronapi.internal.startCamera(\'$ngModel$\')">                     <span class="icon ion-ios-videocam"></span>                   </div>                 </div>',o="";i.maxFileSize&&(o=i.maxFileSize),l=$(l.split("$ngModel$").join(i.ngModel).split("$required$").join(r).split("$userHtml$").join(n).split("$maxFileSize$").join(o)),$(a).html(l),e(l)(a.scope())}}}]).directive("dynamicFile",["$compile",function(e){return{restrict:"A",scope:!0,require:"ngModel",link:function(t,a,i){var r=i.ngRequired&&"true"==i.ngRequired?"required":"",n=i.ngModel.split("."),l=n[0],o=n[n.length-1],s=Math.floor(1e3*Math.random()+20),d=a.html(),c="";i.maxFileSize&&(c=i.maxFileSize);var u='                                <div ng-show="!$ngModel$" ngf-drop="" ngf-drag-over-class="dragover">                                  <div class="btn" ngf-drop="" ngf-select="" ngf-change="cronapi.internal.uploadFile(\'$ngModel$\', $file, \'uploadprogress$number$\')" ngf-max-size="$maxFileSize$">                                    $userHtml$                                  </div>                                  <div class="progress" data-type="bootstrapProgress" id="uploadprogress$number$" style="display:none">                                    <div class="progress-bar" role="progressbar" aria-valuenow="70" aria-valuemin="0" aria-valuemax="100" style="width:0%">                                      <span class="sr-only"></span>                                    </div>                                  </div>                                </div>                                 <div ng-show="$ngModel$" class="upload-image-component-attribute">                                   <div class="button button-assertive" style="float:right;" ng-if="$ngModel$" ng-click="$ngModel$=null">                                     <span class="icon ion-android-close"></span>                                   </div>                                   <div>                                     <div ng-bind-html="cronapi.internal.generatePreviewDescriptionByte($ngModel$)"></div>                                     <a href="javascript:void(0)" ng-click="cronapi.internal.downloadFileEntityMobile($datasource$,\'$field$\')">download</a>                                   </div>                                 </div>                                 ';u=$(u.split("$ngModel$").join(i.ngModel).split("$datasource$").join(l).split("$field$").join(o).split("$number$").join(s).split("$required$").join(r).split("$userHtml$").join(d).split("$maxFileSize$").join(c)),$(a).html(u),e(u)(a.scope())}}}]).directive("pwCheck",[function(){"use strict";return{require:"ngModel",link:function(e,t,a,i){var r="#"+a.pwCheck;t.add(r).on("keyup",function(){e.$apply(function(){var e=t.val()===$(r).val();i.$setValidity("pwmatch",e)})})}}}]).directive("valid",function(){return{require:"^ngModel",restrict:"A",link:function(e,t,a,i){var r={cpf:CPF,cnpj:CNPJ};i.$validators[a.valid]=function(e,i){var n=e||i,l=r[a.valid].isValid(n);return l?t[0].setCustomValidity(""):t[0].setCustomValidity(t[0].dataset.errorMessage),l||!n}}}}).directive("cronappSecurity",function(){return{restrict:"A",link:function(e,t,a){var i=[];e.session&&e.session.roles&&(i=e.session.roles.toLowerCase().split(","));for(var r=parsePermission(a.cronappSecurity),n=!1,l=!1,o=0;o<i.length;o++){var s=i[o].trim();s&&(r.visible[s]&&(n=!0),r.enabled[s]&&(l=!0))}n||$(t).hide(),l||$(t).find("*").addBack().attr("disabled",!0)}}}).directive("cronappStars",[function(){"use strict";return{restrict:"A",require:"ngModel",link:function(e,t,a,i){function r(e){for(var t=1;t<=5;t++)o[t-1].removeClass("ion-android-star-outline"),o[t-1].removeClass("ion-android-star"),t<=e?o[t-1].addClass("ion-android-star"):o[t-1].addClass("ion-android-star-outline");return e}var n=$(t),l=$(n.children().get(0));n.html("");for(var o=[],s=1;s<=5;s++){var d=l.clone();n.append(d),d.attr("idx",s),d.click(function(){e.$apply(function(){i.$viewValue=parseInt($(this).attr("idx")),i.$commitViewValue()}.bind(this))}),o.push(d)}i.$parsers.push(r),i.$formatters.push(r)}}}]).directive("cronappFilter",function(){var setFilterInButton=function(e,t,a){var i=e.closest("fieldset");if(i){var r=i.find("button[cronapp-filter]");if(r){var n=r.data("filters");n||(n=[]);var l=-1,o=e.attr("ng-model");if($(n).each(function(e){this.ngModel==o&&(l=e)}),l>-1&&n.splice(l,1),t.length>0){var s={ngModel:o,bindedFilter:t};n.push(s)}r.data("filters",n)}}},makeAutoPostSearch=function(e,t,a){var i=e.closest("fieldset");if(i&&i.length>0){var r=i.find("button[cronapp-filter]");if(r&&r.length>0){var n=r.data("filters");n&&n.length>0&&(t="",$(n).each(function(){t+=this.bindedFilter+";"}))}}a.search(t)},inputBehavior=function(scope,element,attrs,ngModelCtrl,$element,typeElement,operator,autopost){var filterTemplate="",filtersSplited=attrs.cronappFilter.split(";");$(filtersSplited).each(function(){this.length>0&&(filterTemplate+="text"==typeElement?this+"@"+operator+"%{value}%;":this+operator+"{value};")}),filterTemplate=filterTemplate.length>0?filterTemplate.substr(0,filterTemplate.length-1):"%{value}%",ngModelCtrl?scope.$watch(attrs.ngModel,function(newVal,oldVal){if(!angular.equals(newVal,oldVal)){var eType=$element.data("type")||$element.attr("type"),value=ngModelCtrl.$modelValue,datasource=eval(attrs.crnDatasource);value instanceof Date?(value=value.toISOString(),value+="date"==eType?"@@date":"time"==eType||"time-local"==eType?"@@time":"@@datetime"):"number"==typeof value?value+="@@number":"boolean"==typeof value&&(value+="@@boolean");var bindedFilter=filterTemplate.split("{value}").join(value);0==ngModelCtrl.$viewValue.length&&(bindedFilter=""),setFilterInButton($element,bindedFilter,operator),autopost&&makeAutoPostSearch($element,bindedFilter,datasource)}}):"text"==typeElement?$element.on("keyup",function(){var datasource=eval(attrs.crnDatasource),value=void 0;value=ngModelCtrl&&void 0!=ngModelCtrl?ngModelCtrl.$viewValue:this.value;var bindedFilter=filterTemplate.split("{value}").join(value);0==this.value.length&&(bindedFilter=""),setFilterInButton($element,bindedFilter,operator),autopost&&makeAutoPostSearch($element,bindedFilter,datasource)}):$element.on("change",function(){var datasource=eval(attrs.crnDatasource),value=void 0,typeElement=$(this).attr("type");if(void 0!=attrs.asDate&&(typeElement="date"),ngModelCtrl&&void 0!=ngModelCtrl)value=ngModelCtrl.$viewValue;else if("checkbox"==typeElement)value=$(this).is(":checked");else if("date"==typeElement){if(value=this.value,this.value.length>0){var momentDate=moment(this.value,patternFormat(this));value=momentDate.toDate().toISOString()}}else value=this.value;var bindedFilter=filterTemplate.split("{value}").join(value);0==value.toString().length&&(bindedFilter=""),setFilterInButton($element,bindedFilter,operator),autopost&&makeAutoPostSearch($element,bindedFilter,datasource)})},buttonBehavior=function(scope,element,attrs,ngModelCtrl,$element,typeElement,operator,autopost){$element.on("click",function(){var $this=$(this),datasourceName="";datasourceName=attrs.crnDatasource?attrs.crnDatasource:$element.parent().attr("crn-datasource");var filters=$this.data("filters");if(datasourceName&&datasourceName.length>0&&filters){var bindedFilter="";$(filters).each(function(){bindedFilter+=this.bindedFilter+";"});var datasourceToFilter=eval(datasourceName);datasourceToFilter.search(bindedFilter)}})};return{restrict:"A",require:"?ngModel",link:function(e,t,a,i){var r=$(t),n=r.data("type")||r.attr("type");void 0!=a.asDate&&(n="date");var l="=";a.cronappFilterOperator&&a.cronappFilterOperator.length>0&&(l=a.cronappFilterOperator);var o=!0;a.cronappFilterAutopost&&"false"==a.cronappFilterAutopost&&(o=!1),"INPUT"==r[0].tagName?inputBehavior(e,t,a,i,r,n,l,o):buttonBehavior(e,t,a,i,r,n,l,o)}}})}(app);